version: '3.8'

services:
  # Servicio principal: FastAPI activo permanentemente
  fastapi-app:
    build:
      context: .
      dockerfile: Dockerfile
      target: app-stage
      args:
        - PYTHON_VERSION=3.11
    container_name: fastapi-benchmark-app
    restart: unless-stopped  # Reiniciar automáticamente si falla
    
    # Variables de entorno
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - LOG_LEVEL=INFO
      - BENCHMARK_ENV=docker
      - TZ=America/Mexico_City
    
    # Exponer puerto para acceder a la API
    ports:
      - "8000:8000"
    
    # Volúmenes para persistir logs y resultados
    volumes:
      - ./.logs:/app/.logs:rw
      - ./benchmark_results:/app/benchmark_results:rw
      - ./benchmark_results_improved:/app/benchmark_results_improved:rw
      - ./resultados_nuevos:/app/resultados_nuevos:rw
      - ./resultados_vps:/app/resultados_vps:rw
      - ./app:/app/app:rw  # Hot reload para desarrollo
    
    # Configuración de red
    networks:
      - benchmark-network
    
    # Configuración de recursos
    deploy:
      resources:
        limits:
          cpus: '2.0'      # Máximo 2 CPUs
          memory: 2G       # Máximo 2GB RAM
        reservations:
          cpus: '0.5'      # Mínimo 0.5 CPU
          memory: 512M     # Mínimo 512MB RAM
    
    # Healthcheck para monitoreo
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Configuración de logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Comando por defecto: ejecutar FastAPI con Uvicorn
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]
    
    # Configuración adicional
    stdin_open: true
    tty: true

  # Servicio para ejecutar benchmarks manualmente
  benchmark:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - PYTHON_VERSION=3.11
    container_name: fastapi-benchmark-runner
    restart: "no"  # No reiniciar, solo ejecución manual
    
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - LOG_LEVEL=INFO
      - BENCHMARK_ENV=docker
      - TZ=America/Mexico_City
    
    volumes:
      - ./.logs:/app/.logs:rw
      - ./benchmark_results:/app/benchmark_results:rw
      - ./benchmark_results_improved:/app/benchmark_results_improved:rw
      - ./resultados_nuevos:/app/resultados_nuevos:rw
      - ./resultados_vps:/app/resultados_vps:rw
    
    networks:
      - benchmark-network
    
    # Depende de que fastapi-app esté corriendo
    depends_on:
      - fastapi-app
    
    # Comando por defecto: ejecutar benchmark
    command: ["python", "benchmark_python.py"]
    
    profiles:
      - tools  # Solo se ejecuta con: docker compose --profile tools run benchmark

  # Servicio para análisis de logs (ejecutar manualmente)
  log-analyzer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fastapi-log-analyzer
    restart: "no"
    
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    
    volumes:
      - ./.logs:/app/.logs:rw
      - ./benchmark_results:/app/benchmark_results:rw
    
    networks:
      - benchmark-network
    
    # Comando para análisis (usar docker compose run log-analyzer)
    command: ["python", "analyze_logs.py", "--days", "7", "--format", "all"]
    
    profiles:
      - tools  # Solo se ejecuta con: docker compose --profile tools up

# Configuración de red
networks:
  benchmark-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volúmenes nombrados opcionales
volumes:
  benchmark-logs:
    driver: local
  benchmark-results:
    driver: local
